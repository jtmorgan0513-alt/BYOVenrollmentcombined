# BYOV REFRACTOR INSTRUCTIONS FOR REPLIT AGENT

You are refactoring an existing Streamlit + Node/Vite application.
Follow these instructions EXACTLY and DO NOT perform any other changes.
Do not modify business logic, data models, or calculation code.
Do not simplify, delete, or alter the Node/Vite landing page except where explicitly stated.
If a step is unclear, STOP and ask for clarification instead of guessing.

---

PART 0 — NON-NEGOTIABLE RULES

1. Do NOT change any business logic, VIN decoding, PDF generation, signatures, HR email logic, enrollment validation, or database-related functions.
2. Do NOT change the data schema, stored fields, or expected request/response shapes.
3. Do NOT delete or restructure Node, Vite, Express, or the landing page, except the specific button-path updates listed later.
4. Do NOT merge the enrollment and admin apps back together. They must remain separate Streamlit apps.
5. Do NOT rename files unless the instructions specify.

---

PART 1 — CREATE NEW FILE STRUCTURE

Create two new Streamlit entrypoints:

/enrollment_app.py
/admin_app.py

Create one new shared module:

/dashboard_sync.py

Move the OLD monolithic code from byov_app.py into these two separate apps based on the routing instructions below.

byov_app.py should remain in the repo but become legacy-only after refactor. It should not be used as an entrypoint.

---

PART 2 — ENROLLMENT APP (enrollment_app.py)

Build an app that includes ONLY:

- Landing page intro / lookup workflow
- VIN decode flow
- Vehicle selection + MPG workflow
- Signature collection
- PDF generation
- Email sending
- Final submission logic

Requirements:

1. Add:

    import streamlit as st
    from dashboard_sync import push_to_dashboard   # after you extract it

2. Place:

    st.set_page_config(page_title="Sears BYOV Enrollment", layout="wide")

at the very top of the file. Only call it once.

3. Keep ALL functional logic exactly the same as before. Don’t rename variables or rewrite calculations.

4. Every time the old app pushed completed enrollments to the dashboard, call:

    push_to_dashboard(technician_record)

from the enrollment app.

---

PART 3 — ADMIN APP (admin_app.py)

The admin app must include:

- Login
- Technician list
- Record editing
- Enrollment status management
- Survey management
- SMS messaging
- Recycle bin / soft-delete
- Audit log
- PDF review/download

Requirements:

1. Add:

    import streamlit as st
    from dashboard_sync import (
        pull_dashboard_data,
        push_dashboard_update,
    )

2. Put:

    st.set_page_config(page_title="BYOV Admin Dashboard", layout="wide")

at the top of the file ONLY (do not call set_page_config anywhere else).

3. Build an admin home page that uses the existing UI structure but may reorganize layout using:

- st.tabs
- st.expander
- st.columns

4. Apply the admin theme:

Create a small helper inside admin_app.py:

    def inject_admin_theme_css():
        st.markdown(open("byov-preferred.html").read(), unsafe_allow_html=True)

Call this after login and before rendering the main dashboard UI.

---

PART 4 — DASHBOARD SYNC MODULE (dashboard_sync.py)

Move ALL dashboard-syncing functions out of the old combined file.

This module must contain the following three functions (names must match exactly):

- pull_dashboard_data()
- push_to_dashboard(record)
- push_dashboard_update(updated_record)

They must keep the same logic that currently exists in the app. Do not change request bodies, JSON structures, field names, or endpoints.

Both enrollment_app.py and admin_app.py must import from this module.

Remove any circular dependencies.

---

PART 5 — NODE / EXPRESS CONFIGURATION

You must NOT restructure the project, rename files, or change build tools.

You are only allowed to change the landing page button routes.

Update the paths so:

- “Technician Enrollment” → open('/enroll')
- “Admin Control Center” → open('/admin')

Do not change the layout, styling, Vite configuration, build steps, or Express middleware.

---

PART 6 — STREAMLIT PROCESS MANAGEMENT FROM NODE SERVER

Modify the server so it launches two separate Streamlit processes:

- ENROLL_STREAMLIT_PORT = 8000
- ADMIN_STREAMLIT_PORT = 8001

Replace the old single-proxy logic with TWO proxies:

- /enroll  → Streamlit process at port 8000
- /admin   → Streamlit process at port 8001

You must support:

- HTTP requests
- WebSockets (required by Streamlit)

Remove any reference to the old single STREAMLIT_PORT.

---

PART 7 — LANDING PAGE BUTTONS

Modify ONLY the click handlers or button hrefs on the landing page so that:

- Enrollment button → /enroll
- Admin button → /admin

Do not change any wording, styling, animations, or HTML structure.

---

PART 8 — CLEANUP

1. Remove unused imports in all touched files.
2. Update all Streamlit and internal references to use the new modules.
3. Make sure no file imports byov_app.
4. Leave byov_app.py in place but unused. Add a comment:

    # Legacy-only. Not used after refactor.

---

PART 9 — COMPLETION CHECKLIST (AGENT MUST VERIFY)

Before finishing, confirm:

Enrollment App:
- [ ] Starts successfully
- [ ] Can complete full enrollment end-to-end
- [ ] Generates PDF
- [ ] Sends email
- [ ] Pushes enrollment to dashboard

Admin App:
- [ ] Loads with theme applied
- [ ] Login works
- [ ] Technician list loads
- [ ] Edit/update/delete works
- [ ] Survey management works
- [ ] Custom SMS works
- [ ] Recycle bin works
- [ ] Audit log works

Infrastructure:
- [ ] Node/Vite untouched except button routes
- [ ] Two Streamlit processes start
- [ ] Proxy routing functions for both apps
- [ ] No circular imports
- [ ] No broken imports
- [ ] No change to business logic

Only when all items pass, respond:

"Refactor complete."
